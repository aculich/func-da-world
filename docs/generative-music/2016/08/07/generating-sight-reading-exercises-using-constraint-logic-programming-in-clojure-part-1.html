<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Generating Sight-Reading Exercises using Constraint Logic Programming in Clojure, Part 1 | Func Da World</title>
  <meta name="description" content="This is the first post in a series about generating sheet music for sight-reading exercises, using Clojure and core.logic.">

  <link rel="icon" type="image/png" href="/assets/icon.png">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" media="print" href="/css/print.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Cabin:400,400i|Inconsolata|Montserrat:700">

  <link rel="canonical" href="https://owickstrom.github.io/generative-music/2016/08/07/generating-sight-reading-exercises-using-constraint-logic-programming-in-clojure-part-1.html">
  <link rel="alternate" type="application/rss+xml" title="Func Da World" href="https://owickstrom.github.io/feed.xml">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="owickstrom">
  
  <meta name="twitter:title" content="Generating Sight-Reading Exercises using Constraint Logic Programming in Clojure, Part 1">
  
  
  <meta name="twitter:url" content="https://owickstrom.github.io/generative-music/2016/08/07/generating-sight-reading-exercises-using-constraint-logic-programming-in-clojure-part-1.html">
  
  
  <meta name="twitter:description" content="Oskar Wickström on functional programming.
">
  
  <meta name="twitter:image:src" content="https://owickstrom.github.io/assets/square.png">
</head>


  <body>

    <nav class="top-nav">
  <div class="wrapper">
    <a href="/" class="home">
      <img src="/assets/logo.png"
          srcset="/assets/logo.png 1x,
          /assets/logo@2x.png 2x"
          alt="FUNC DA WORLD">
    </a>
    <div class="nav">
      <ul>
        
  
  

  <li class="first  ">
    <a class="" href="/archive.html">Archive</a>
  </li>

  
  

  <li class="  last">
    <a class="" href="/about.html">About</a>
  </li>


      </ul>
    </div>
  </div>
</nav>


<div class="page-content">
  <div class="wrapper">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

      <header class="page-header post-header">
        <h1 class="page-title post-title" itemprop="name headline">Generating Sight-Reading Exercises using Constraint Logic Programming in Clojure, Part 1</h1>
        <p class="post-meta">
          <time datetime="2016-08-07T08:00:00+02:00" itemprop="datePublished">August 7, 2016</time> by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Oskar Wickström</span></span>
          
          
          <span class="category">
          In <a href="/generative-music">generative music</a>
          </span>
          
        </p>
      </header>

      <div class="post-content" itemprop="articleBody">
        <p><em>This is the first post in a series about generating sheet music for sight-reading exercises, using Clojure and core.logic. The size and direction of the series is not set in stone; your feedback matters! Please post a comment or get in touch on <a href="twitter">Twitter</a>.</em></p>
<h2 id="introduction">Introduction</h2>
<p>Programming is fun! Music is fun! Combining the two should be a joyful endeavour. I have long been curious about generating music as a tool for practicing sight-reading. It does not have to be beautiful music, its purpose is to help practitioners advance their skills gradually. I do, however, want to explore ways to generate music following patterns and idioms, resulting in realistic and useful material.</p>
<h3 id="what-you-need-to-know">What You Need to Know</h3>
<p>This post introduces concepts both from music theory and from constraint logic programming using <a href="https://github.com/clojure/core.logic">core.logic</a>. You are not expected to have any knowledge about music theory. Some familiarity with core.logic, or logic programming languages like Prolog or miniKanren, is needed. I recommend you to go through <a href="https://github.com/clojure/core.logic/wiki/A-Core.logic-Primer">the core.logic primer</a> for an introduction.</p>
<h2 id="defining-the-musical-model">Defining the Musical Model</h2>
<p>Music theory is a huge area with lots of rules and exceptions. Trying to include all those rules in our initial attempts at a music generator would not be productive. Let's instead define the model for our program by picking a subset of the constructs and rules from music theory, and incrementally expand that model to meet our needs.</p>
<p>Our first step is to define the goals of our project. I have asked some of my musician friends what they think is the most important traits of a sight-reading exercise. The following is a list based on my own evaluation, and their responses, in order of importance.</p>
<ol type="1">
<li>Rythmic variation</li>
<li>Pitch variation</li>
<li>Common rythmic patterns</li>
<li>Rests</li>
<li>Interesting pitch variations (melodies, scales, patterns)</li>
<li>Key signatures, modes, accidentals</li>
<li>Parameterized difficulty</li>
<li>Dotted notes</li>
<li>Ties</li>
<li>Playback (generate a MIDI or WAV file)</li>
<li>Odd time signatures</li>
</ol>
<p>In this post we will work with points 1-3. I hope this series will be able to cover most or all of the aspects in the list.</p>
<p>As a complement to the prioritized list, we will look at a piece of music that exhibits the elements and patterns we want in a generated sight-reading exercise. <a href="#score-1">Score 1</a> is a four-measure melody I wrote by hand. In my personal taste this melody does not sound random or generated, it is musical. We will use it as an inspiration and long-term goal for our music-generator project.</p>
<figure class="lilypond music">
<span id="score-1"></span> <img src="/generated/24eb7d08e0e050b799aa5f3685dd0c8e36eea06b77cbf2ea73f95da76fb46354.1x.png" srcset="/generated/24eb7d08e0e050b799aa5f3685dd0c8e36eea06b77cbf2ea73f95da76fb46354.1x.png 1x, /generated/24eb7d08e0e050b799aa5f3685dd0c8e36eea06b77cbf2ea73f95da76fb46354.2x.png 2x" alt="A hand-written melodious sight reading exercise." />
<figcaption>
<span class="caption-number">Score 1:</span> A hand-written melodious sight reading exercise.
</figcaption>
</figure>
<p>Let's have a closer look at the music in <a href="#score-1">Score 1</a>. I will cover only the minimum amount of music theory needed to understand the rest of the post. If you are interested in digging deeper, I encourage you to check out <a href="http://tobyrush.com/theorypages/">Music Theory for Musicians and Normal People</a> for a light introduction to music theory.</p>
<p>The music in <a href="#score-1">Score 1</a> is in the key of C major, or A minor. A key signature is a set of sharp (<img src="/assets/music/sharp.1x.png"
      srcset="/assets/music/sharp.2x.png 2x, /assets/music/sharp.1x.png 1x"
      alt="Sharp sign"
      style="margin: 0 .25em;">) or flat (<img src="/assets/music/flat.1x.png"
      srcset="/assets/music/flat.2x.png 2x, /assets/music/flat.1x.png 1x"
      alt="Flat sign"
      style="margin: 0 .25em;">) symbols, raising or lowering the note on the line it is placed, until the next key signature, or to the end of the score. A sharp raises the note by a semitone, a flat lowers the note by a semitone. In our example we have no sharp or flat symbols in the key signature, thus all notes are in the diatonic C scale. <a href="#score-2">Score 2</a> shows a key signature for music in the key of D major, raising all F notes to F#, and all C notes to C#.</p>
<figure class="lilypond music">
<span id="score-2"></span> <img src="/generated/c1ed2f237283328522c42502a0fb902028925924f861c40c9abd49c6e44235e7.1x.png" srcset="/generated/c1ed2f237283328522c42502a0fb902028925924f861c40c9abd49c6e44235e7.1x.png 1x, /generated/c1ed2f237283328522c42502a0fb902028925924f861c40c9abd49c6e44235e7.2x.png 2x" alt="Music in the key of D major." />
<figcaption>
<span class="caption-number">Score 2:</span> Music in the key of D major.
</figcaption>
</figure>
<p>Please see <a href="https://en.wikipedia.org/wiki/Circle_of_fifths">Circle of fifths</a> for more information on key signatures, major and minor keys, and diatonic scales. For the purpose of this post you will only need to be aware that keys exist and that key signatures affect the notes to be played in a score.</p>
<p><a href="#score-1">Score 1</a> consists of four measures, also called <em>bars</em>, divided by bar lines. The time signature is 4/4, as denoted by the common time sign (<img src="/assets/music/common-time.1x.png"
      srcset="/assets/music/common-time.2x.png 2x, /assets/music/common-time.1x.png 1x"
      alt="Common time sign"
      style="margin: 0 .25em;">). With a time signature of 4/4, the total value of notes in each bar must equal 4/4. It might be tempting to say that the total value of a bar must be 1 at all times, but it is not that simple. In other time signatures, such as 3/4, 6/8, and 5/4, the total is not 1.</p>
<p>The following table describes the used note symbols and their meaning. It is in no way a complete list of musical symbols.</p>
<table class="musical-signs">
<thead>
<tr>
<th>
Symbol
</th>
<th>
Value
</th>
<th>
Duration
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<img src="/assets/music/half.1x.png"
     srcset="/assets/music/half.2x.png 2x, /assets/music/half.1x.png 1x"
     alt="Half note">
</td>
<td>
Half note
</td>
<td>
1/2
</td>
</tr>
<tr>
<td>
<img src="/assets/music/half.1x.png"
     srcset="/assets/music/quarter.2x.png 2x, /assets/music/quarter.1x.png 1x"
     alt="Quarter note">
</td>
<td>
Quarter note
</td>
<td>
1/4
</td>
</tr>
<tr>
<td>
<img src="/assets/music/half.1x.png"
     srcset="/assets/music/eighth.2x.png 2x, /assets/music/eighth.1x.png 1x"
     alt="Eighth note">
</td>
<td>
Eighth note
</td>
<td>
1/8
</td>
</tr>
<tr>
<td>
<img src="/assets/music/sixteenth.1x.png"
     srcset="/assets/music/sixteenth.2x.png 2x, /assets/music/sixteenth.1x.png 1x"
     alt="Sixteenth note">
</td>
<td>
Sixteenth note
</td>
<td>
1/16
</td>
</tr>
<tr>
<td>
<img src="/assets/music/dotted-eighth.1x.png"
     srcset="/assets/music/dotted-eighth.2x.png 2x, /assets/music/dotted-eighth.1x.png 1x"
     alt="Dotted eighth note">
</td>
<td>
Dotted eighth note
</td>
<td>
3/16
</td>
</tr>
<tr>
<td>
<img src="/assets/music/half-rest.1x.png"
     srcset="/assets/music/half-rest.2x.png 2x, /assets/music/half-rest.1x.png 1x"
     alt="Dotted eighth note">
</td>
<td>
Half rest
</td>
<td>
1/2
</td>
</tr>
<tr>
<td>
<img src="/assets/music/quarter-rest.1x.png"
     srcset="/assets/music/quarter-rest.2x.png 2x, /assets/music/quarter-rest.1x.png 1x"
     alt="Dotted eighth note">
</td>
<td>
Quarter rest
</td>
<td>
1/4
</td>
</tr>
<tr>
<td>
<img src="/assets/music/eighth-rest.1x.png"
     srcset="/assets/music/eighth-rest.2x.png 2x, /assets/music/eighth-rest.1x.png 1x"
     alt="Dotted eighth note">
</td>
<td>
Eighth rest
</td>
<td>
1/8
</td>
</tr>
</tbody>
</table>
<div class="caption">
Notes, and their symbols, used in <a href="#score-1">Score 1</a>.
</div>
<p>A note describes both the pitch of a sound, and the relative duration of the sound. The vertical position in the staff, along with key signature and accidentals, determines the pitch. The <em>note value</em>, written using differents note head shapes, stem, and beams, determines the relative duration.</p>
<p>The note values in the conventional Western music system are <em>dyadic rational numbers</em>, i.e. rational numbers where the denominator is a power of two. Note values can be modified using dots. A dot adds the next shorter note value to the original note value, effectively making it one and half times longer. The technique of using dotted notes is similar to how inch units are divided in the imperial system.</p>
<figure>
<img alt="Dyadic rational sub-divisions"
     src="/assets/dyadic-rational-subdivisions.svg"/>
<figcaption>
Dyadic rational divisions. Graphic from <a href="https://en.wikipedia.org/wiki/File:Dyadic_rational.svg">Wikipedia</a>.
</figcaption>
</figure>
<p>Another way of describing such note values is by <em>tying</em> multiple notes together. The following two scores have the same musical meaning, in that they sound the same way, but <a href="#score-3">Score 3</a> is notated using ties, and <a href="#score-4">Score 4</a> is notated using dotted notes.</p>
<figure class="lilypond music">
<span id="score-3"></span> <img src="/generated/cf33fa675ff02d40f673a406897e302c2a40392d463891a9bcd4fd5a933caf06.1x.png" srcset="/generated/cf33fa675ff02d40f673a406897e302c2a40392d463891a9bcd4fd5a933caf06.1x.png 1x, /generated/cf33fa675ff02d40f673a406897e302c2a40392d463891a9bcd4fd5a933caf06.2x.png 2x" alt="Using ties for 3/8 and 3/16 duration notes." />
<figcaption>
<span class="caption-number">Score 3:</span> Using ties for 3/8 and 3/16 duration notes.
</figcaption>
</figure>
<figure class="lilypond music">
<span id="score-4"></span> <img src="/generated/abeeb272b7db166914ade0b7e6756020b4efae2a3ca2a9d57d3f99b2f439c4a0.1x.png" srcset="/generated/abeeb272b7db166914ade0b7e6756020b4efae2a3ca2a9d57d3f99b2f439c4a0.1x.png 1x, /generated/abeeb272b7db166914ade0b7e6756020b4efae2a3ca2a9d57d3f99b2f439c4a0.2x.png 2x" alt="Using dotted notes for 3/8 and 3/16 duration notes." />
<figcaption>
<span class="caption-number">Score 4:</span> Using dotted notes for 3/8 and 3/16 duration notes.
</figcaption>
</figure>
<p>Another important aspect of musical notation is <em>note grouping</em>. This technique helps the reader to see the sub-divisions of a bar by visually grouping notes. Notes are commonly grouped within quarter and eighth note durations, depending on the note values. <a href="#score-5">Score 5</a> shows a phrase of quarter notes following a single sixteenth note, without any grouping. The same phrase is written with note groups in <a href="#score-6">Score 6</a> for greater readability.</p>
<figure class="lilypond music">
<span id="score-5"></span> <img src="/generated/138722819bb23d2cdf3a6bf00286d9f3b5bff63fad96c9ec429abc3b90032f60.1x.png" srcset="/generated/138722819bb23d2cdf3a6bf00286d9f3b5bff63fad96c9ec429abc3b90032f60.1x.png 1x, /generated/138722819bb23d2cdf3a6bf00286d9f3b5bff63fad96c9ec429abc3b90032f60.2x.png 2x" alt="A phrase without proper grouping is harder to read." />
<figcaption>
<span class="caption-number">Score 5:</span> A phrase without proper grouping is harder to read.
</figcaption>
</figure>
<figure class="lilypond music">
<span id="score-6"></span> <img src="/generated/7080571fbcb0e2146bed9ff1f6e64eda24c3b2ebfd346404ce88ced6a2338b0e.1x.png" srcset="/generated/7080571fbcb0e2146bed9ff1f6e64eda24c3b2ebfd346404ce88ced6a2338b0e.1x.png 1x, /generated/7080571fbcb0e2146bed9ff1f6e64eda24c3b2ebfd346404ce88ced6a2338b0e.2x.png 2x" alt="Quarter notes spanning groups are split into dotted eighth notes and sixteenth notes, and tied together." />
<figcaption>
<span class="caption-number">Score 6:</span> Quarter notes spanning groups are split into dotted eighth notes and sixteenth notes, and tied together.
</figcaption>
</figure>
<p>Exceptions are made for common rythmic patterns, like the eighth note followed by a <em>single</em> quarter note and an eighth note, illustrated in <a href="#score-7">Score 7</a>. Multiple quarter notes following an eighth note should be grouped, as shown in <a href="#score-8">Score 8</a>.</p>
<figure class="lilypond music">
<span id="score-7"></span> <img src="/generated/357ef89f5bd6d6b3d7039bddc6ba9562a9c8ad893d9493907c1c18401b0aaece.1x.png" srcset="/generated/357ef89f5bd6d6b3d7039bddc6ba9562a9c8ad893d9493907c1c18401b0aaece.1x.png 1x, /generated/357ef89f5bd6d6b3d7039bddc6ba9562a9c8ad893d9493907c1c18401b0aaece.2x.png 2x" alt="A common rythmic pattern that does not need grouping." />
<figcaption>
<span class="caption-number">Score 7:</span> A common rythmic pattern that does not need grouping.
</figcaption>
</figure>
<figure class="lilypond music">
<span id="score-8"></span> <img src="/generated/7d9333f2de5620173e1bd0654bb49cf3fd4e1977c96a1773b8e97b301cf3b73a.1x.png" srcset="/generated/7d9333f2de5620173e1bd0654bb49cf3fd4e1977c96a1773b8e97b301cf3b73a.1x.png 1x, /generated/7d9333f2de5620173e1bd0654bb49cf3fd4e1977c96a1773b8e97b301cf3b73a.2x.png 2x" alt="Multiple quarter notes broken up into tied eighth notes." />
<figcaption>
<span class="caption-number">Score 8:</span> Multiple quarter notes broken up into tied eighth notes.
</figcaption>
</figure>
<p>We have just scratched the surface of music theory in describing the first piece of music, but we have enough of a model to start generating simple sight-reading exercises. Let's start by building a simple program using core.logic, and then gradually add constraints to make the generated music more realistic and challenging.</p>
<h2 id="a-naive-generator">A Naive Generator</h2>
<p>We start out building our first naive generator by only encoding very basic properties of notes and bars. As we are generating sheet music, let's call this project <em>SMUG</em>, short for <u>S</u>heet <u>Mu</u>sic <u>G</u>enerator. We begin by declaring our namespace and requiring <code>clojure.core.logic</code> and <code>clojure.core.logic.fd</code>. The <code>fd</code> namespace contains the stuff we need to work with finite domains.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">ns</span> smug.music
  (<span class="kw">:refer-clojure</span> <span class="kw">:exclude</span> [<span class="kw">==</span>])
  (<span class="kw">:require</span> [clojure.core.logic <span class="kw">:refer</span> <span class="kw">:all</span>]
            [clojure.core.logic.fd <span class="kw">:as</span> fd]))</code></pre></div>
<p>A note has a pitch and a value. We represent the pitch as an integer between 1 and 7, inclusive. To use finite domain constraints we need to find ways of representing the values in <em>our domain</em> as integers. We will map the results of queries to other data types later. Using <code>interval</code> we create a finite domain based on a set of numbers, and constrain <code>p</code> to that domain.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> pitcho </span>[p]
  (fd/in p (fd/interval <span class="dv">1</span> <span class="dv">7</span>)))</code></pre></div>
<p>Similarly to note pitch, we represent the note value as an integer. In this case, however, the note value is not within a range of numbers, but a number in the set <code>{1, 2, 4, 8, 16}</code> , representing the numerators in the dyadic rationals 1/16, 2/16, 4/16, 8/16, and 16/16. In other words, with this representation we only support the note values from whole notes down to sixteenth notes. Using <code>domain</code> we create a finite domain based on the set of numbers, and constrain <code>v</code> to that domain.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> note-valueo </span>[v]
  (fd/in v (fd/domain <span class="dv">1</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">8</span> <span class="dv">16</span>)))</code></pre></div>
<p>Let's compose these two relations into a note relation, with the pair of pitch and note value as a vector. We use <code>defne</code> to define a relation that destructures a note into its parts, <code>p</code> and <code>v</code>, and then constrain the pitch and note value.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(defne noteo [note]
  ([ [p v] ]
   (pitcho p)
   (note-valueo v)))</code></pre></div>
<p>A bar can be represented as a sequence of notes. Using our <code>noteo</code> relation, we recursively describe the sequence. The first branch matches the empty sequence and succeeds. The second branch matches the non-empty sequence, constrains the first element to be a note, and recurses on the rest of the sequence.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(defne noteso [notes]
  ([ [] ])
  ([ [n . <span class="kw">ns</span>] ]
   (noteo n)
   (noteso <span class="kw">ns</span>)))</code></pre></div>
<p>We are soon ready to define <code>baro</code>, but first we need a way to ensure that the note values add up to a total of 16. To make the generator support different time signatures we would have to make that number configurable. For now we will only generate music in 4/4, so hard-coding 16 is fine.</p>
<p>For empty sequences the total is zero. For non-empty sequences we ensure that <code>v</code> is a note value and unify <code>total</code> with <code>s</code>, where <code>s</code> is the sum of <code>v</code> and the total of the remaining notes.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(defne notes-total-valueo [notes total]
  ([ [] _ ]
   (fd/== total <span class="dv">0</span>))
  ([ [[p v] . <span class="kw">ns</span>] _ ]
   (fresh (s)
     (note-valueo v)
     (fd/+ v s total)
     (notes-total-valueo <span class="kw">ns</span> s))))</code></pre></div>
<p>This definition is analogous to how <code>(reduce + (map first notes))</code> would work on a sequence <code>notes</code> using regular Clojure data structures, but as we are using logic variables we can't use <code>reduce</code> and <code>first</code>; we have to describe the logical relation of the reduction.</p>
<p>The last relation define is called <code>baro</code>. It simply states that a bar is a sequence of notes, and that the total note value must be 16.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> baro </span>[notes]
  (fresh []
    (noteso notes)
    (notes-total-valueo notes <span class="dv">16</span>)))</code></pre></div>
<p>We use <code>run</code> to query for bars. The following query gives us 32 valid bars, neatly pretty-printed in the REPL.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">smug.music&gt; (clojure.pprint/pprint
             (run <span class="dv">32</span> [q]
               (baro q)))
<span class="co">;; output:</span>
(([<span class="dv">1</span> <span class="dv">16</span>])
 ([<span class="dv">2</span> <span class="dv">16</span>])
 ([<span class="dv">3</span> <span class="dv">16</span>])
 ([<span class="dv">4</span> <span class="dv">16</span>])
 ([<span class="dv">5</span> <span class="dv">16</span>])
 ([<span class="dv">6</span> <span class="dv">16</span>])
 ([<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">7</span> <span class="dv">16</span>])
 ([<span class="dv">2</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">3</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">4</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">5</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">6</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">7</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">2</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">2</span>])
 ([<span class="dv">2</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">3</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">2</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">2</span>])
 ([<span class="dv">3</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">4</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">2</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">2</span>])
 ([<span class="dv">1</span> <span class="dv">1</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">1</span>])
 ([<span class="dv">4</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">3</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">4</span>])
 ([<span class="dv">2</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">2</span>])
 ([<span class="dv">5</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">8</span>])
 ([<span class="dv">2</span> <span class="dv">1</span>] [<span class="dv">1</span> <span class="dv">8</span>] [<span class="dv">1</span> <span class="dv">4</span>] [<span class="dv">1</span> <span class="dv">2</span>] [<span class="dv">1</span> <span class="dv">1</span>]))</code></pre></div>
<p>The output is a bit crude; a sequence of sequences of pairs of integers. Let's define some conversion functions to make the results reflect the domain of musical notation.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> -&gt;pitch </span>[p]
  (<span class="kw">nth</span> [<span class="kw">:c</span> <span class="kw">:d</span> <span class="kw">:e</span> <span class="kw">:f</span> <span class="kw">:g</span> <span class="kw">:a</span> <span class="kw">:b</span>] (<span class="kw">-</span> p <span class="dv">1</span>)))

(<span class="kw">defn</span><span class="fu"> -&gt;note-value </span>[d]
  (<span class="kw">/</span> d <span class="dv">16</span>))

(<span class="kw">defn</span><span class="fu"> -&gt;note </span>[[p d]]
  [(-&gt;pitch p)
   (-&gt;note-value d)])

(<span class="kw">defn</span><span class="fu"> -&gt;bar </span>[bar]
  (<span class="kw">map</span> -&gt;note bar))</code></pre></div>
<p>All right, let's try again.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">smug.music&gt; (clojure.pprint/pprint
             (<span class="kw">map</span> -&gt;bar (run <span class="dv">32</span> [q]
                          (baro q))))
<span class="co">;; output:</span>
(([<span class="kw">:c</span> <span class="dv">1</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>])
 ([<span class="kw">:e</span> <span class="dv">1</span>])
 ([<span class="kw">:f</span> <span class="dv">1</span>])
 ([<span class="kw">:g</span> <span class="dv">1</span>])
 ([<span class="kw">:a</span> <span class="dv">1</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:b</span> <span class="dv">1</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:e</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:f</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:g</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:a</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:b</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:e</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:e</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:f</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:f</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:g</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:e</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:d</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:g</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>]))</code></pre></div>
<p>Neat! Let's wrap all this up in to function that we can use as the API for the generator. Here we wrap the sequence of bars in a map as well. Later on we can add other key-value pairs to the map, like the time and key signatures.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> generate-score </span>[n]
  (<span class="kw">let</span> [bars (run n [q]
               (baro q))]
    {<span class="kw">:bars</span> (<span class="kw">map</span> -&gt;bar bars)}))</code></pre></div>
<p>We now have a very simple generator. The average musician does not read music in the form of Clojure data literals, though. We need rendering. I stumbled across <a href="http://lilypond.org/">Lilypond</a>, a music engraving program in the <a href="http://gnu.org/">GNU Project</a>. The input format is a TeX-like markup that is simple to generate, and the program can output stunningly beautiful scores in PDF, PNG, and SVG formats. To keep the post focused, I will not include the rendering code, but you can check out <a href="https://github.com/owickstrom/smug/tree/blog-post-1">the full source on GitHub</a> if you are interested. <a href="#score-9">Score 9</a> shows our previous result rendered with Lilypond.</p>
<figure class="lilypond music">
<span id="score-9"></span> <img src="/generated/eb478bf1fca8a95825e2ccd5a016f3295b78707d2813fd913eb6a23d0f5544e9.1x.png" srcset="/generated/eb478bf1fca8a95825e2ccd5a016f3295b78707d2813fd913eb6a23d0f5544e9.1x.png 1x, /generated/eb478bf1fca8a95825e2ccd5a016f3295b78707d2813fd913eb6a23d0f5544e9.2x.png 2x" alt="Our generated 32 bars of music." />
<figcaption>
<span class="caption-number">Score 9:</span> Our generated 32 bars of music.
</figcaption>
</figure>
<p>Remember note grouping from the music theory introduction? When we render the generated music, like in <a href="#score-9">Score 9</a>, the lack of proper note grouping becomes very clear. Bar 22, 26, and 28 have intolerable sequences of notes values without grouping. Let's fix that!</p>
<h2 id="note-grouping">Note Grouping</h2>
<p>We need to define relations that constrain groups of notes depending on their note values. To make it more practical we introduce a new level in our hierarchy of sequences that represents note groups. A bar consist of a seqence of groups of notes, rather than a sequence of notes. <a href="#score-10">Score 10</a> contains the note groupings that we will support.</p>
<figure class="lilypond music">
<span id="score-10"></span> <img src="/generated/f8dd8cda28e16d633f36946ac285cba98b8ad0c66196af8b6c2a0c61ea1d51a1.1x.png" srcset="/generated/f8dd8cda28e16d633f36946ac285cba98b8ad0c66196af8b6c2a0c61ea1d51a1.1x.png 1x, /generated/f8dd8cda28e16d633f36946ac285cba98b8ad0c66196af8b6c2a0c61ea1d51a1.2x.png 2x" alt="Matched note groups in the groupo relation." />
<figcaption>
<span class="caption-number">Score 10:</span> Matched note groups in the groupo relation.
</figcaption>
</figure>
<p>Let's define the new relation <code>groupo</code>. It is similar to our previous <code>baro</code> relation, but matches the group of notes to ensure that the note values follow one of the predefined patterns. The last branch matches on a group with a single note longer or equal to a quarter note.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> groupo </span>[notes duration]
  (all
   (noteso notes)
   (note-valueo duration)
   (matche [notes]
           ([ [[_ <span class="dv">1</span>] [_ <span class="dv">1</span>] [_ <span class="dv">1</span>] [_ <span class="dv">1</span>]] ]
            (fd/== duration <span class="dv">4</span>))
           ([ [[_ <span class="dv">1</span>] [_ <span class="dv">2</span>] [_ <span class="dv">1</span>]] ]
            (fd/== duration <span class="dv">4</span>))
           ([ [[_ <span class="dv">2</span>] [_ <span class="dv">1</span>] [_ <span class="dv">1</span>]] ]
            (fd/== duration <span class="dv">4</span>))
           ([ [[_ <span class="dv">1</span>] [_ <span class="dv">1</span>] [_ <span class="dv">2</span>]] ]
            (fd/== duration <span class="dv">4</span>))
           ([ [[_ <span class="dv">2</span>] [_ <span class="dv">2</span>]] ]
            (fd/== duration <span class="dv">4</span>))
           ([ [[_ <span class="dv">2</span>] [_ <span class="dv">4</span>] [_ <span class="dv">2</span>]] ]
            (fd/== duration <span class="dv">8</span>))
           ([ [[_ v]] ]
            (fd/&gt;= v <span class="dv">4</span>)
            (fd/== duration v)))))</code></pre></div>
<p>We also need the <code>groupso</code> relation for sequences of groups, with a parameter for the total duration.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(defne groupso [groups duration]
  ([ [] _ ]
   (fd/== duration <span class="dv">0</span>))
  ([ [g . gs] _ ]
   (fresh [group-total sub-total]
     (groupo g group-total)
     (fd/+ group-total sub-total duration)
     (groupso gs sub-total))))</code></pre></div>
<p>The <code>baro</code> relation can now be simplified to only constrain groups in a bar to have a total duration of 16.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> baro </span>[groups]
  (groupso groups <span class="dv">16</span>))</code></pre></div>
<p>We need to flatten the groups to keep our external format intact. This way note grouping is only a concern in the generator.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> flatten-groups </span>[groups]
  (<span class="kw">map</span> #(<span class="kw">apply</span> <span class="kw">concat</span> %<span class="dv">1</span>) groups))

(<span class="kw">defn</span><span class="fu"> generate-score </span>[n]
  (<span class="kw">let</span> [groups (run n [q]
                 (baro q))
        bars (flatten-groups groups)]
    {<span class="kw">:bars</span> (<span class="kw">map</span> -&gt;bar bars)}))</code></pre></div>
<p>To verify the behaviour of <code>groupo</code> we temporarily constrain the note pitch to only take the value 1, the note C, by redefining <code>pitcho</code> in the REPL.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">smug.music&gt; (<span class="kw">defn</span><span class="fu"> pitcho </span>[p]
              (fd/in p (fd/domain <span class="dv">1</span>)))
<span class="kw">#&#39;</span>smug.music/pitcho</code></pre></div>
<p>As the first bars consist of simpler note values we generate a score of 64 bars and drop the first half.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">smug.music&gt; (clojure.pprint/pprint
             (<span class="kw">-&gt;&gt;</span> (generate-score <span class="dv">64</span>)
                  <span class="kw">:bars</span>
                  (<span class="kw">drop</span> <span class="dv">32</span>)))
<span class="co">;; output:</span>
(([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">4</span>])
 ([<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">16</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">2</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>] [<span class="kw">:c</span> <span class="dv">1</span>/<span class="dv">8</span>]))</code></pre></div>
<p>Looks good. <a href="#score-11">Score 11</a> shows the rendered result.</p>
<figure class="lilypond music">
<span id="score-11"></span> <img src="/generated/b281aa2bd959dd0093b24d70830f83cdf4e9c0f584af21bbff827d272a659281.1x.png" srcset="/generated/b281aa2bd959dd0093b24d70830f83cdf4e9c0f584af21bbff827d272a659281.1x.png 1x, /generated/b281aa2bd959dd0093b24d70830f83cdf4e9c0f584af21bbff827d272a659281.2x.png 2x" alt="A generated score with note groups." />
<figcaption>
<span class="caption-number">Score 11:</span> A generated score with note groups.
</figcaption>
</figure>
<p>Sweet, it works! That concludes our work on note groups, for now.</p>
<h2 id="summary">Summary</h2>
<p>We have gone through the basic music theory we need for our project, and created a simple generator on which we can improve incrementally. There are some problems with the relations still, like <code>(run 8 [q] (groupo q 16))</code> not terminating. This seems to cause the same behaviour when trying to generate a score of more than 308 bars. If anyone knows why, please let me know. I'll try to find out why before the next post.</p>
<p>Anyway, we can now cross of the first three points on our list:</p>
<ol type="1">
<li><s>Rythmic variation</s></li>
<li><s>Pitch variation</s></li>
<li><s>Common rythmic patterns</s></li>
<li>Interesting pitch variations (melodies, scales, patterns)</li>
<li>Rests</li>
<li>Key signatures, modes, accidentals</li>
<li>Parameterized difficulty</li>
<li>Dotted notes</li>
<li>Ties</li>
<li>Playback (generate a MIDI or WAV file)</li>
<li>Odd time signatures</li>
</ol>
<p>We still have no randomness in our generator, so we get the same result every time. This really defeats the purpose of a sight-reading exercise generator. Even if we eventually need to add it, I think it's a good idea to wait until we have nailed our other objectives. This way, it is much easier to verify how or relations work.</p>
<p>The SMUG source code for this post is available on GitHub <a href="https://github.com/owickstrom/smug/tree/blog-post-1">at the <code>blog-post-1</code> tag</a>. I hope you enjoyed the read and will continue following the series. Don't forget to help me steer this thing in the right direction by letting me know what's interesting to read about.</p>

      </div>

      <a id="post-comments-link"
         href="#disqus_thread"
         data-disqus-identifier="generating-sight-reading-exercises-using-constraint-logic-programming-in-clojure-part-1">
      </a>
      <noscript class="no-javascript">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments</a>.</noscript>
    </article>
  </div>
</div>

<div class="page-comments hidden" id="post-comments">
  <div class="wrapper">
    <div id="disqus_thread"></div>
    <script src="/js/comments.js"></script>
    <script>
    initializeComments('https://owickstrom.github.io/generative-music/2016/08/07/generating-sight-reading-exercises-using-constraint-logic-programming-in-clojure-part-1.html', 'generating-sight-reading-exercises-using-constraint-logic-programming-in-clojure-part-1');
    </script>
    <script id="dsq-count-scr" src="//owickstrom.disqus.com/count.js" async></script>
  </div>
</div>

<footer class="site-footer">

  <div class="wrapper">
    <p><a class="rss-subscribe" href="/feed.xml">Subscribe via RSS</a></p>
    <p class="copyright">Copyright &copy; 2015 Oskar Wickström</p>
  </div>

</footer>



    <script>
function loadCssAsync(path) {
  function cb() {
    var l = document.createElement('link'); l.rel = 'stylesheet';
    l.href = path;
    var h = document.getElementsByTagName('head')[0]; h.appendChild(l, h);
  };
  var raf = requestAnimationFrame || mozRequestAnimationFrame ||
  webkitRequestAnimationFrame || msRequestAnimationFrame;
  if (raf) raf(cb);
  else window.addEventListener('load', cb);
};

loadCssAsync('/css/syntax-highlighting.css');
</script>

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42197774-2', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
